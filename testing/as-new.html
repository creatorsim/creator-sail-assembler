<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Emscripten-Generated Code</title>
  </head>
  <body>
    <div id="popup" style="display: none; position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); z-index: 1000;">
      <p id="popup-message"></p>
      <button onclick="document.getElementById('popup').style.display = 'none';">Cerrar</button>
  </div>
    <textarea></textarea>
    <input type="file" id="FileInput" multiple>
    <button id="lanzarwasm"> Compilar ensamblador</button>

    <script>
      const fpdextension = ["fadd.s", "fadd.d", "fsub.s", "fsub.d", "fmul.s", "fmul.d", "fdiv.s", "fdiv.d", "fsqrt.s", "fsqrt.d", "fmadd.s", 
                            "fmadd.d", "fmsub.s", "fmsub.d", "fnmadd.s", "fnmadd.d", "fnmsub.s", "fnmsub.d", "fcvt.w.s", "fcvt.wu.s", "fcvt.w.d", 
                            "fcvt.wu.d", "fcvt.s.w", "fcvt.s.wu", "fcvt.d.w", "fcvt.d.wu", "feq.s", "feq.d", "flt.s", "flt.d", "fle.s", "fle.w", 
                            "fsgnj.s", "fsgnj.d", "fsgnjn.s", "fsgnjn.d", "fsgnjx.s", "fsgnjx.d", "fclass.s", "fclass.d", "fmax.s", "fmax.d", 
                            "fmin.s", "fmin.d", "flw", "flsw", "fld", "fsd"];
      const vecextension = ["vle8.v", "vse8.v", "vle16.v", "vse16.v", "vle32.v", "vse32.v", "vle64.v", "vse64.v", "vadd.vv", "vadd.vx", "vadd.vi",
                           "vsub.vv", "vsub.vx", "vmul.vv", "vmul.vx", "vdiv.vv", "vdiv.vx", "vand.vv", "vor.vv", "vxor.vv", "vnot.v", "vsll.vv", 
                           "vsrl.vv", "vsra.vv", "vmseq.vv", "vmsne.vv", "vmslt.vv", "vmsle.vv"];
      // Crear una expresión regular optimizada
      const regexfpd = new RegExp(`\\b(${fpdextension.join('|')})\\b`, 'g');
      const regexvec = new RegExp(`\\b(${vecextension.join('|')})\\b`, 'g');

      let enablefpd = false;
      let enablevec = false;
      const fileInput = document.getElementById('FileInput');
      var linkercontent, objectcontent, elffile, file, content, reader, scriptas, scriptld;
      const filenames = [];
      const filecontents = [];

      function showPopup(message) {
        const popup = document.getElementById('popup');
        const messageElement = document.getElementById('popup-message');
        
        messageElement.textContent = message; // Establece el mensaje
        popup.style.display = 'block';       // Muestra el popup
      }

      fetch('./linker.ld')
        .then(response => {
          return response.text();})
        .then(data => {
          linkercontent = data;
        });

        fileInput.addEventListener('change', () => {
        filenames.length = 0;
        filecontents.length = 0;

        Array.from(fileInput.files).forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = function(event) {
            filenames.push(file.name);
            filecontents.push(event.target.result);
          };
          reader.readAsText(file);
        });
        console.log("Nombre de los ficheros:", filenames);
        console.log("Contenido de los mismos:",filecontents);
      });

      function clean_environment() {
        const moduleKeys = [
            'ENVIRONMENT', 'HEAP16', 'HEAP32', 'HEAP8', 'HEAPF32', 'HEAPF64', 'HEAPU16', 
            'HEAPU32', 'HEAPU8', 'INITIAL_MEMORY', 'TOTAL_MEMORY', 'TOTAL_STACK', '_main', 
            'arguments', 'asm', 'calledRun', 'cdInitializerPrefixURL', 'extraStackTrace', 
            'filePackagePrefixURL', 'inspect', 'instantiateWasm', 'locateFile', 'logReadFiles', 
            'memoryInitializerPrefixURL', 'monitorRunDependencies', 'noExitRuntime', 'noInitialRun', 
            'onAbort', 'onExit', 'onRuntimeInitialized', 'postRun', 'preInit', 'preRun', 'print', 
            'printErr', 'pthreadMainPrefixURL', 'quit', 'read', 'readAsync', 'readBinary', 'run', 
            'setStatus', 'setWindowTitle', 'stderr', 'stdin', 'stdout', 'thisProgram', 'wasmBinary', 
            'wasmMemory'
        ];
        
        moduleKeys.forEach(key => {
            delete Module[key];
        });
        if ( typeof preprocess_run === "function")
          preprocess_run = undefined;
        if (typeof preprocess_ld === "function")
          preprocess_ld = undefined;
        if (typeof preprocess_sail === "function")
          preprocess_sail = undefined;
      }

      async function loadSailFunction(){
        while (typeof preprocess_sail === 'undefined' ) {
            await new Promise(resolve => setTimeout(resolve, 100)); // Espera 100 ms antes de volver a verificar
        }
        preprocess_sail(elffile, enablefpd, enablevec);

      }


      async function waitForFunction(maxAttemps = 50) {
        let attemps = 0;
        while (typeof preprocess_ld === 'undefined' && attemps < maxAttemps) {
            await new Promise(resolve => setTimeout(resolve, 100)); // Espera 100 ms antes de volver a verificar
        }
        elffile = preprocess_ld(objectcontent, linkercontent); // Llamamos a runner_ld cuando preprocess_ld esté definida
        
        // const outputfile = FS.readFile('./my_code_v2.o');
        // const blob = new Blob([elffile], { type: "application/octet-stream"});

        // const url = URL.createObjectURL(blob);
        // const a = document.createElement("a");

        // a.href = url;
        // a.download = "output.elf";
        // document.body.appendChild(a);
        // a.click();
        // document.body.removeChild(a);
        // URL.revokeObjectURL(url);
        
        scriptld.parentNode.removeChild(scriptld);
        clean_environment();

        
        scriptsail = document.createElement('script');
        scriptsail.src = 'riscv_sim_RV32.js';
        scriptsail.async = true;
        scriptsail.type = 'text/javascript';
        
        document.head.appendChild(scriptsail);
      
      
      }

      // Funcion para limpiar el entorno en caso de que haya ocurrido algun error durante la ejecución 
      // o si ha ido exitoso para volver a utilizarlo sin tener que recargar la página.
      function resetenvironment (){
        clean_environment();
        scriptas = document.querySelector('script[src="as-new.js"]');
        scriptld = document.querySelector('script[src="ld-new.js"]');
        scriptsail = document.querySelector('script[src="riscv_sim_RV64.js"]');
        
        if(scriptas)
          scriptas.parentNode.removeChild(scriptas);
        if(scriptld)
          scriptld.parentNode.removeChild(scriptld);
        if(scriptsail)
          scriptsail.parentNode.removeChild(scriptsail);
        
        scriptas = document.createElement('script');
        scriptas.src = 'as-new.js';
        scriptas.async = true;
        scripas.type = 'text/javascript';
        document.head.appendChild(scriptas);
      }


      document.getElementById('lanzarwasm').addEventListener('click', () => {
        document.getElementById('lanzarwasm').disabled = true;

        try{
          console.log("Antes de comprobar el flag");
        for (let i = 0; i < filecontents.length; i++){
          if(filecontents[i].match(regexfpd))
            enablefpd = true;
          if(filecontents[i].match(regexvec))
            enablevec = true;
        }
        console.log("post comprobacion del flag", enablefpd, enablevec);
        objectcontent = preprocess_run(filenames, filecontents, enablefpd, enablevec);
        scriptas = document.querySelector('script[src="as-new.js"]');
        
        if(scriptas){
          clean_environment();
          scriptas.parentNode.removeChild(scriptas);
        }
        
        // Se carga el script ld.js para ejecutar el enlazador.
        scriptld = document.createElement('script');
        scriptld.src = 'ld-new.js';
        scriptld.async = true;
        scriptld.type = 'text/javascript';
        document.head.appendChild(scriptld);

        waitForFunction();// Reset por si quiere modificar algo y volver a compilar sin recargar la página
        showPopup("Compilacion realizada correctamente!");
        loadSailFunction(enablefpd, enablevec);

      } catch(error){
        showPopup("Error en la compilacion!");
        console.error("No se ha compilado correctamente");

      } finally {
        // resetenvironment();
        document.getElementById('lanzarwasm').disabled = false;

      }

    });
    </script>
    <script async type="text/javascript" src="as-new.js"></script>
    <!-- <script async type="text/javascript" src="riscv_sim_RV64.js"></script> -->
    
  </body>
</html>


